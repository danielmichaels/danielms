<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name=" robots" content="noindex, nofollow">
<title>TIL How Network Time Protocol Works | Daniel Michaels | Software Developer</title>

<meta name="keywords" content="linux, TIL" />
<meta name="description" content="Network Time Protocol So today I watched a talk on NTP and it was amazing. I will do my best to summarise the core parts in this post.
 What is it? Network Time Protocol allows clocks between computers to be synchronised over the internet or local area network. It was developed by [David L. Mills] (https://en.wikipedia.org/wiki/David_L._Mills) in 1985 and is currently in its fourth version. Accurate to a few milliseconds of Coordinated Universal Time, NTP is a fundamental instrument in modern networking.">
<meta name="author" content="Daniel Michaels">
<link rel="canonical" href="https://danielms.site/blog/til-how-network-time-protocol-works/" />
<link href="https://danielms.site/assets/css/stylesheet.min.08d6f2005b6ce4ed10207916c0411c66e66f2201e3f7a56e8fb2ccbc4a8b259c.css" integrity="sha256-CNbyAFts5O0QIHkWwEEcZuZvIgHj96Vuj7LMvEqLJZw=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://danielms.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://danielms.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://danielms.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://danielms.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://danielms.site/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.78.1" />




</head>

<body class="single" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        .theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://danielms.site/" accesskey="h">Daniel Michaels | Software Developer</a>
            <span class="logo-switches">
                <span class="theme-toggle">
                    <a id="theme-toggle" accesskey="t">
                        <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </a>
                </span>
                
            </span>
        </div>
        <ul class="menu" id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://danielms.site/blog/">
                    <span>
                        Blog
                    </span>
                </a>
            </li>
            <li>
                <a href="https://danielms.site/about/">
                    <span>
                        About
                    </span>
                </a>
            </li>
            <li>
                <a href="https://github.com/danielmichaels">
                    <span>
                        Code
                    </span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">
      TIL How Network Time Protocol Works
    </h1>
    <div class="post-meta">

March 23, 2018&nbsp;Â·&nbsp;Daniel Michaels

    </div>
  </header> 

  <div class="post-content">
<h2 id="network-time-protocol">Network Time Protocol<a hidden class="anchor" aria-hidden="true" href="#network-time-protocol">#</a></h2>
<p>So today I watched a <a href="https://www.youtube.com/watch?v=MDmNvVG9AnQ">talk</a>
on NTP and it was amazing. I will do my best to summarise the core parts
in this post.</p>
<hr>
<h3 id="what-is-it">What is it?<a hidden class="anchor" aria-hidden="true" href="#what-is-it">#</a></h3>
<p>Network Time Protocol allows clocks between computers to be synchronised
over the internet or local area network. It was developed by [David L.
Mills]
(<a href="https://en.wikipedia.org/wiki/David_L._Mills">https://en.wikipedia.org/wiki/David_L._Mills</a>) in
1985 and is currently in its fourth version. Accurate to a few
milliseconds of Coordinated Universal Time, NTP is a fundamental
instrument in modern networking.</p>
<h3 id="why-do-we-need-it">Why do we need it?<a hidden class="anchor" aria-hidden="true" href="#why-do-we-need-it">#</a></h3>
<p>Its pretty important that we all agree on what time it is. It is even
more important that banks and other financial institutions agree on a
universal time stamp when conducting transactions, especially if they
are ordered chronologically. Things like SSL certificates could be
spoofed or bypassed if NTP did not ensure a universal time. There is
probably many other security related issues that NTP solves but I think
the point is clear, its a necessary protocol.</p>
<h3 id="how-does-it-get-the-right-time">How does it get the &ldquo;right&rdquo; time?<a hidden class="anchor" aria-hidden="true" href="#how-does-it-get-the-right-time">#</a></h3>
<p>Most people have heard of [atomic clocks]
(<a href="https://en.wikipedia.org/wiki/Atomic_clock">https://en.wikipedia.org/wiki/Atomic_clock</a>) or GPS
time. Basically, these methods are considered as accurate as humans can
calculate to &lsquo;real&rsquo; time. It would be simplistic to say that NTP polls
these sources for the current time - but nonetheless that&rsquo;s the basic
premise.</p>
<p>Diving deeper, NTP actually uses things called a &lsquo;Stratum&rsquo;. An atomic
clock is a Stratum 0, also known as a reference clock. The Stratum&rsquo;s go
from 0 all the way to 16. Stratum 1 is the closest an NTP server can get
to the reference clock, and is usually within a few milliseconds. These
are referred to as primary time servers. Each Stratum refers to the
preceding number, and polls that server for its time. Stratum 3 will
synchronise to a Stratum 2 server for example. They can and often do
peer with servers in their own Stratum as a sanity check and backup. Of
note Stratum 16 means &lsquo;unsynchronised&rsquo;.</p>
<hr>
<h3 id="the-process">The Process<a hidden class="anchor" aria-hidden="true" href="#the-process">#</a></h3>
<p>Roughly the process follows something like this:</p>
<ul>
<li>ask for the time,</li>
<li>get the roundtrip times,</li>
<li>figure out if you trust the response,</li>
<li>make any adjustments,</li>
<li>repeat every 64 seconds, forever.</li>
</ul>
<h4 id="roundtrip-times">Roundtrip Times<a hidden class="anchor" aria-hidden="true" href="#roundtrip-times">#</a></h4>
<p>After asking the time from a server, NTP needs to factor in how long it
took to get the response back because the time from when it sent the
response to receiving it will now be out of sync.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># The four timestamps needed for calculating the time</span>
<span class="nv">t1</span> <span class="o">=</span> timestamp of request packet
<span class="nv">t2</span> <span class="o">=</span> timestamp when server received packet
<span class="nv">t3</span> <span class="o">=</span> timestamp of servers reply transmission
<span class="nv">t4</span> <span class="o">=</span> clients response packet reception timestamp
</code></pre></div><p>Example of NTP packet</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">13:11:58.155997 IP <span class="o">(</span>tos 0x0, ttl 56, id 42684, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 76<span class="o">)</span>
    cpe-110-141-196-84.vic.asp.telstra.net.ntp &gt; client.local.lan.ntp: <span class="o">[</span>udp sum ok<span class="o">]</span> NTPv4, length <span class="m">48</span>
    Server, Leap indicator:  <span class="o">(</span>0<span class="o">)</span>, Stratum <span class="m">1</span> <span class="o">(</span>primary reference<span class="o">)</span>, poll <span class="m">10</span> <span class="o">(</span>1024s<span class="o">)</span>, precision -23
    Root Delay: 0.000000, Root dispersion: 0.001953, Reference-ID: PPS^@
      Reference Timestamp:  3730684254.163282214 <span class="o">(</span>2018/03/22 13:10:54<span class="o">)</span> <span class="c1"># t1</span>
      Originator Timestamp: 3730684318.091658531 <span class="o">(</span>2018/03/22 13:11:58<span class="o">)</span> <span class="c1"># t2</span>
      Receive Timestamp:    3730684318.125586175 <span class="o">(</span>2018/03/22 13:11:58<span class="o">)</span> <span class="c1"># t3</span>
      Transmit Timestamp:   3730684318.125623665 <span class="o">(</span>2018/03/22 13:11:58<span class="o">)</span> <span class="c1"># t4</span>
        Originator - Receive Timestamp:  +0.033927643
        Originator - Transmit Timestamp: +0.033965133
</code></pre></div><p>To calculate the current time from the servers response NTP does the
following calculation:</p>
<pre><code>t4 - t1 = roundtrip time
roundtrip time / 2 = one-way latency
t3 + one-way latency = current time
</code></pre>
<p>The next part of this is whether or not the client trusts the NTP
server. This is done in a few ways. Firstly, by sending out several
queries to several servers rather than trusting that the response from
one server is correct. NTP then favours the lowest latency and discards
any outliers. Secondly, NTP uses some statistical analysis of its
responses over a period of minutes to determines who is accurate and who
isn&rsquo;t based off those statistics.</p>
<h4 id="make-adjustments">Make Adjustments<a hidden class="anchor" aria-hidden="true" href="#make-adjustments">#</a></h4>
<p>What NTP tries to never do is go backwards in time. Sometimes it has to
and we will get to that. But for the most part what it does it &lsquo;slew&rsquo;
the clock. Simply it just slows or speeds up the clock to match the
correct time and does this in a gradual way with small increments.</p>
<p>At its max adjustment speed of 500ppm it would take 2000 seconds to make
an adjustment of just one second!</p>
<p>Given the slow slew rate, slewing is capped to 128 milliseconds.
Anything above that cannot be slewed and must be &lsquo;stepped&rsquo; or jumped to
the correct time, be it forward or backward. This does not happen often
except in cases such as bringing a machine back online after maintenance
or during initial setup. Any machine that is over 1000 seconds out must
be manually configured within that threshold or it will not be able to
receive adjustments.</p>
<hr>
<h3 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h3>
<p>That&rsquo;s Network Time Protocol in a nutshell. I had never paid much heed
to NTP prior to <a href="https://twitter.com/jpotischj">Joel Potischman&rsquo;s</a> talk
at !!Con. He gave a great talk and it only goes for ten minutes and uses
some good graphs and visualisations that are missing from this post. If
you want to see NTP in action on your computer you can use
<code>tcpdump -vv port 123</code> or check it out in wireshark. Whilst
writing this I found a bad response from one server that was +1023
seconds out and thus dropped as an outlier - so it does happen.</p>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://danielms.site/tags/linux">linux</a></li>
      <li><a href="https://danielms.site/tags/til">TIL</a></li>
    </ul>
  </footer>
</article>
    </main><footer class="footer">
    <span>&copy; 2020 <a href="https://danielms.site/">Daniel Michaels | Software Developer</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top" accesskey="g">
    <button class="top-link" id="top-link" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6">
            <path d="M12 6H0l6-6z" /></svg>
    </button>
</a>



<script defer src="https://danielms.site/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js" integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                behavior: "smooth"
            });
        });
    });
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

</body>

</html>
