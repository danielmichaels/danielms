<!DOCTYPE html>
<html lang="en" data-theme=""><head>
    <title> Daniel Michaels | TIL How Network Time Protocol Works </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.80.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="I build things and drink coffee.">
    
    <link rel="stylesheet"
          href="https://danielms.site/css/style.min.9a6700e4461b50dccdddfc4f81dc65d77e7fca22c35665e398a0c36568db59c7.css"
          integrity="sha256-mmcA5EYbUNzN3fxPgdxl135/yiLDVmXjmKDDZWjbWcc="
          crossorigin="anonymous"
          type="text/css">
    
    <link rel="stylesheet"
        href="https://danielms.site/css/markupHighlight.min.cc84ed683057cc175ddfa738ea6ba2d5c882b95cb64f50bf9be918cb3791887b.css"
        integrity="sha256-zITtaDBXzBdd36c46mui1ciCuVy2T1C/m&#43;kYyzeRiHs="
        crossorigin="anonymous"
        type="text/css">
    
    <link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" 
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" 
    crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="https://danielms.site/extra/favicon.icofavicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://danielms.site/extra/favicon.icoapple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://danielms.site/extra/favicon.icofavicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://danielms.site/extra/favicon.icofavicon-16x16.png">

    <link rel="canonical" href="https://danielms.site/blog/til-how-network-time-protocol-works/">

    
    
    
    
    <script type="text/javascript"
            src="https://danielms.site/js/anatole-header.min.d8599ee07b7d3f11bafbac30657ccc591e8d7fd36a9f580cd4c09e24e0e4a971.js"
            integrity="sha256-2Fme4Ht9PxG6&#43;6wwZXzMWR6Nf9Nqn1gM1MCeJODkqXE="
            crossorigin="anonymous"></script>


    
        
        
        <script type="text/javascript"
                src="https://danielms.site/js/anatole-theme-switcher.min.e289e9ebb2a4e7a7f895859c8a2b0da2de1ec73f22cea58d8475aa0597023837.js"
                integrity="sha256-4onp67Kk56f4lYWciisNot4exz8izqWNhHWqBZcCODc="
                crossorigin="anonymous"></script>
    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="TIL How Network Time Protocol Works"/>
<meta name="twitter:description" content="Network Time Protocol So today I watched a talk on NTP and it was amazing."/>


    
    <meta property="og:title" content="TIL How Network Time Protocol Works" />
<meta property="og:description" content="Network Time Protocol So today I watched a talk on NTP and it was amazing." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://danielms.site/blog/til-how-network-time-protocol-works/" />
<meta property="article:published_time" content="2018-03-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-03-23T00:00:00+00:00" /><meta property="og:site_name" content="Daniel Michaels ðŸ‡¦ðŸ‡º" />

</head>
<body><div class="sidebar animated fadeInDown ">
    <div class="logo-title">
        <div class="title">
            <img src="https://danielms.site/extra/cover.jpeg" alt="profile picture">
            <h3 title=""><a href="/">Daniel Michaels ðŸ‡¦ðŸ‡º</a></h3>
            <div class="description">
                <p>I build things and drink coffee.</p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="https://linkedin.com/in/daniel-michaels" rel="me" aria-label="Linkedin">
                    <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/danielmichaels/" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://www.twitter.com/dansult/" rel="me" aria-label="twitter">
                    <i class="fab fa-twitter fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="mailto:dan@mudmap.io" rel="me" aria-label="e-mail">
                    <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; Daniel Michaels  2018-2021 </div>
    </div>
</div>
<div class="main">
    <div class="page-top  animated fadeInDown ">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Home</a></li>
        
            
            <li><a 
                   href="/blog/"
                        
                   title="">Blog</a></li>
        
            
            <li><a 
                   href="/retrospectives/"
                        
                   title="">Retrospectives</a></li>
        
            
            <li><a 
                   href="/projects/"
                        
                   title="">Projects</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">About</a></li>
        
        
        
            <li class="theme-switch-item">
                <a class="theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
    <div class="post  animated fadeInDown ">
        <div class="post-content">
            
            <div class="post-title">
                <h3>TIL How Network Time Protocol Works</h3>
                
            </div>

            <h2 id="network-time-protocol">Network Time Protocol</h2>
<p>So today I watched a <a href="https://www.youtube.com/watch?v=MDmNvVG9AnQ">talk</a>
on NTP and it was amazing. I will do my best to summarise the core parts
in this post.</p>
<hr>
<h3 id="what-is-it">What is it?</h3>
<p>Network Time Protocol allows clocks between computers to be synchronised
over the internet or local area network. It was developed by [David L.
Mills]
(<a href="https://en.wikipedia.org/wiki/David_L._Mills">https://en.wikipedia.org/wiki/David_L._Mills</a>) in
1985 and is currently in its fourth version. Accurate to a few
milliseconds of Coordinated Universal Time, NTP is a fundamental
instrument in modern networking.</p>
<h3 id="why-do-we-need-it">Why do we need it?</h3>
<p>Its pretty important that we all agree on what time it is. It is even
more important that banks and other financial institutions agree on a
universal time stamp when conducting transactions, especially if they
are ordered chronologically. Things like SSL certificates could be
spoofed or bypassed if NTP did not ensure a universal time. There is
probably many other security related issues that NTP solves but I think
the point is clear, its a necessary protocol.</p>
<h3 id="how-does-it-get-the-right-time">How does it get the &ldquo;right&rdquo; time?</h3>
<p>Most people have heard of [atomic clocks]
(<a href="https://en.wikipedia.org/wiki/Atomic_clock">https://en.wikipedia.org/wiki/Atomic_clock</a>) or GPS
time. Basically, these methods are considered as accurate as humans can
calculate to &lsquo;real&rsquo; time. It would be simplistic to say that NTP polls
these sources for the current time - but nonetheless that&rsquo;s the basic
premise.</p>
<p>Diving deeper, NTP actually uses things called a &lsquo;Stratum&rsquo;. An atomic
clock is a Stratum 0, also known as a reference clock. The Stratum&rsquo;s go
from 0 all the way to 16. Stratum 1 is the closest an NTP server can get
to the reference clock, and is usually within a few milliseconds. These
are referred to as primary time servers. Each Stratum refers to the
preceding number, and polls that server for its time. Stratum 3 will
synchronise to a Stratum 2 server for example. They can and often do
peer with servers in their own Stratum as a sanity check and backup. Of
note Stratum 16 means &lsquo;unsynchronised&rsquo;.</p>
<hr>
<h3 id="the-process">The Process</h3>
<p>Roughly the process follows something like this:</p>
<ul>
<li>ask for the time,</li>
<li>get the roundtrip times,</li>
<li>figure out if you trust the response,</li>
<li>make any adjustments,</li>
<li>repeat every 64 seconds, forever.</li>
</ul>
<h4 id="roundtrip-times">Roundtrip Times</h4>
<p>After asking the time from a server, NTP needs to factor in how long it
took to get the response back because the time from when it sent the
response to receiving it will now be out of sync.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># The four timestamps needed for calculating the time</span>
<span class="nv">t1</span> <span class="o">=</span> timestamp of request packet
<span class="nv">t2</span> <span class="o">=</span> timestamp when server received packet
<span class="nv">t3</span> <span class="o">=</span> timestamp of servers reply transmission
<span class="nv">t4</span> <span class="o">=</span> clients response packet reception timestamp
</code></pre></div><p>Example of NTP packet</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">13:11:58.155997 IP <span class="o">(</span>tos 0x0, ttl 56, id 42684, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto UDP <span class="o">(</span>17<span class="o">)</span>, length 76<span class="o">)</span>
    cpe-110-141-196-84.vic.asp.telstra.net.ntp &gt; client.local.lan.ntp: <span class="o">[</span>udp sum ok<span class="o">]</span> NTPv4, length <span class="m">48</span>
    Server, Leap indicator:  <span class="o">(</span>0<span class="o">)</span>, Stratum <span class="m">1</span> <span class="o">(</span>primary reference<span class="o">)</span>, poll <span class="m">10</span> <span class="o">(</span>1024s<span class="o">)</span>, precision -23
    Root Delay: 0.000000, Root dispersion: 0.001953, Reference-ID: PPS^@
      Reference Timestamp:  3730684254.163282214 <span class="o">(</span>2018/03/22 13:10:54<span class="o">)</span> <span class="c1"># t1</span>
      Originator Timestamp: 3730684318.091658531 <span class="o">(</span>2018/03/22 13:11:58<span class="o">)</span> <span class="c1"># t2</span>
      Receive Timestamp:    3730684318.125586175 <span class="o">(</span>2018/03/22 13:11:58<span class="o">)</span> <span class="c1"># t3</span>
      Transmit Timestamp:   3730684318.125623665 <span class="o">(</span>2018/03/22 13:11:58<span class="o">)</span> <span class="c1"># t4</span>
        Originator - Receive Timestamp:  +0.033927643
        Originator - Transmit Timestamp: +0.033965133
</code></pre></div><p>To calculate the current time from the servers response NTP does the
following calculation:</p>
<pre><code>t4 - t1 = roundtrip time
roundtrip time / 2 = one-way latency
t3 + one-way latency = current time
</code></pre>
<p>The next part of this is whether or not the client trusts the NTP
server. This is done in a few ways. Firstly, by sending out several
queries to several servers rather than trusting that the response from
one server is correct. NTP then favours the lowest latency and discards
any outliers. Secondly, NTP uses some statistical analysis of its
responses over a period of minutes to determines who is accurate and who
isn&rsquo;t based off those statistics.</p>
<h4 id="make-adjustments">Make Adjustments</h4>
<p>What NTP tries to never do is go backwards in time. Sometimes it has to
and we will get to that. But for the most part what it does it &lsquo;slew&rsquo;
the clock. Simply it just slows or speeds up the clock to match the
correct time and does this in a gradual way with small increments.</p>
<p>At its max adjustment speed of 500ppm it would take 2000 seconds to make
an adjustment of just one second!</p>
<p>Given the slow slew rate, slewing is capped to 128 milliseconds.
Anything above that cannot be slewed and must be &lsquo;stepped&rsquo; or jumped to
the correct time, be it forward or backward. This does not happen often
except in cases such as bringing a machine back online after maintenance
or during initial setup. Any machine that is over 1000 seconds out must
be manually configured within that threshold or it will not be able to
receive adjustments.</p>
<hr>
<h3 id="conclusion">Conclusion</h3>
<p>That&rsquo;s Network Time Protocol in a nutshell. I had never paid much heed
to NTP prior to <a href="https://twitter.com/jpotischj">Joel Potischman&rsquo;s</a> talk
at !!Con. He gave a great talk and it only goes for ten minutes and uses
some good graphs and visualisations that are missing from this post. If
you want to see NTP in action on your computer you can use
<code>tcpdump -vv port 123</code> or check it out in wireshark. Whilst
writing this I found a bad response from one server that was +1023
seconds out and thus dropped as an outlier - so it does happen.</p>
</div>
        <div class="post-footer">
            <div class="info">
                <span class="separator"><a class="category" href="/categories/til/">TIL</a></span>

                <span class="separator"><a class="tag" href="/tags/linux/">linux</a><a class="tag" href="/tags/til/">TIL</a></span>

            </div>
        </div>

        
    </div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="https://danielms.site/js/jquery.min.86b1e8f819ee2d9099a783e50b49dff24282545fc40773861f9126b921532e4c.js"
        integrity="sha256-hrHo&#43;BnuLZCZp4PlC0nf8kKCVF/EB3OGH5EmuSFTLkw="
        crossorigin="anonymous"></script>




<script type="text/javascript"
        src="https://danielms.site/js/bundle.min.0f9c74cb78f13d1f15f33daff4037c70354f98acfbb97a6f61708966675c3cae.js"
        integrity="sha256-D5x0y3jxPR8V8z2v9AN8cDVPmKz7uXpvYXCJZmdcPK4="
        crossorigin="anonymous"></script>

<script type="text/javascript"
        src="https://danielms.site/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js"
        integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro="
        crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-149607103-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</body>

</html>
