<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name=" robots" content="noindex, nofollow">
<title>Dropbear and AWS | Daniel Michaels | Software Developer</title>

<meta name="keywords" content="ssh" />
<meta name="description" content="BusyBox, SSH and EC2 Accessing an EC2 instance from BusyBox&rsquo;s Dropbear SSH client isn&rsquo;t easy. Firstly, .pem files are not compatible with dropbear, nor can you convert them to dropbear&rsquo;s key format with the built-in dropbearconvert. Secondly, depending on your version of openssh it may not be immediately apparent that your private keys are incompatible with the conversion application either. Thankfully, workarounds are possible.
Dropbear SSH Dropbear is a lightweight client and server application mostly seen on embedded devices.">
<meta name="author" content="Daniel Michaels">
<link rel="canonical" href="https://danielms.site/blog/dropbear-aws-pem-keys/" />
<link href="https://danielms.site/assets/css/stylesheet.min.08d6f2005b6ce4ed10207916c0411c66e66f2201e3f7a56e8fb2ccbc4a8b259c.css" integrity="sha256-CNbyAFts5O0QIHkWwEEcZuZvIgHj96Vuj7LMvEqLJZw=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://danielms.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://danielms.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://danielms.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://danielms.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://danielms.site/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.78.1" />




</head>

<body class="single" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        .theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://danielms.site/" accesskey="h">Daniel Michaels | Software Developer</a>
            <span class="logo-switches">
                <span class="theme-toggle">
                    <a id="theme-toggle" accesskey="t">
                        <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </a>
                </span>
                
            </span>
        </div>
        <ul class="menu" id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://danielms.site/blog/">
                    <span>
                        Blog
                    </span>
                </a>
            </li>
            <li>
                <a href="https://danielms.site/about/">
                    <span>
                        About
                    </span>
                </a>
            </li>
            <li>
                <a href="https://github.com/danielmichaels">
                    <span>
                        Code
                    </span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">
      Dropbear and AWS
    </h1>
    <div class="post-meta">

September 10, 2019&nbsp;Â·&nbsp;Daniel Michaels

    </div>
  </header> 

  <div class="post-content">
<h1 id="busybox-ssh-and-ec2">BusyBox, SSH and EC2<a hidden class="anchor" aria-hidden="true" href="#busybox-ssh-and-ec2">#</a></h1>
<p><img src="https://danielms.site/images/bash-terminal.png" alt="terminal" title="terminal graphic"></p>
<p>Accessing an EC2 instance from BusyBox&rsquo;s Dropbear SSH client isn&rsquo;t easy. Firstly, <code>.pem</code> files are not compatible with <code>dropbear</code>, nor can you convert them to dropbear&rsquo;s key format with the built-in <code>dropbearconvert</code>. Secondly, depending on your version of <code>openssh</code> it may not be immediately apparent that your private keys are incompatible with the conversion application either. Thankfully, workarounds are possible.</p>
<h2 id="dropbear-ssh">Dropbear SSH<a hidden class="anchor" aria-hidden="true" href="#dropbear-ssh">#</a></h2>
<p>Dropbear is a lightweight client and server application mostly seen on embedded devices. It is designed to replace OpenSSH in low memory footprint systems as it can be compiled down to <a href="https://lists.ucc.gu.uwa.edu.au/pipermail/dropbear/2004q3/000022.html">110kb</a>.
It is compatible with <code>.ssh/authorized_keys</code>, however it does have limitations.</p>
<h2 id="those-limitations">Those limitations<a hidden class="anchor" aria-hidden="true" href="#those-limitations">#</a></h2>
<p>Amazon Web Services such as Elastic Cloud Compute hand out private keys for passwordless login. Unfortunately for dropbear users, the format is <code>.pem</code> which is incompatible. And, <code>dropbearconvert</code> - the program provided for turning <code>openssh</code> keys into <code>dropbear</code> keys - does not accept <code>.pem</code> files.</p>
<p>Dropbear&rsquo;s conversion tool will also not accept private keys from <code>openssh</code>, as seen below.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAtNY9pkKAhGYD/qDIThmRd7Y8kMo7QvbSQj+tv5huz4hTqdgALmxP
....
<span class="nv">FBuu7Rt2qQdJPBAAAADGRhbmllbEBBbm9hdAECAwQFBg</span><span class="o">==</span>
-----END OPENSSH PRIVATE KEY-----
</code></pre></div><p>Instead, it must be an <code>rsa</code> key like so.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">-----BEGIN RSA PRIVATE KEY-----
VY2Q002wQjJzfA783q0wPwPgdQVNBj8timSYHTmZLlZ54pPtBLhMvZ4tJ/AeXxSm
MIIEpQIBAAKCAQEA4N5r5Z+/rl2lmNdxsmcqyhfZ49m1g/5mIMSdPbTXgKcn2T3o
...
pEJt+8fBAoGBAM2KBHEA5RFnv812nGJG6f2scaMxufbQh5vtc0tf7DDAPqmHlnqr
-----END RSA PRIVATE KEY-----
</code></pre></div><h2 id="the-workaround">The workaround<a hidden class="anchor" aria-hidden="true" href="#the-workaround">#</a></h2>
<p>I found the most reliable means to gain access to EC2 from <code>dropbear</code> on <code>busybox</code> was to create the keys elsewhere and then move them to the device manually.</p>
<h3 id="the-steps">The steps<a hidden class="anchor" aria-hidden="true" href="#the-steps">#</a></h3>
<h4 id="1-create-a-public-and-private-key-on-either-the-aws-ec2-instance-or-your-local-machine-with">1. Create a public and private key on either the AWS EC2 instance, or your local machine with:<a hidden class="anchor" aria-hidden="true" href="#1-create-a-public-and-private-key-on-either-the-aws-ec2-instance-or-your-local-machine-with">#</a></h4>
<ul>
<li><code>ssh-keygen -m PEM -t rsa -b 4096 -f &lt;new_privkey&gt;</code></li>
</ul>
<h4 id="2-copy-the-_private_-key-to-busybox">2. Copy the <em>private</em> key to BusyBox:<a hidden class="anchor" aria-hidden="true" href="#2-copy-the-_private_-key-to-busybox">#</a></h4>
<ul>
<li><code>scp &lt;priv_key_filename&gt; &lt;user&gt;@&lt;busybox&gt;:/&lt;user&gt;/.ssh/</code></li>
</ul>
<h4 id="3-copy-the-private-key-to-the-cloud---_only-if-doing-these-steps-on-your-local-system_">3. Copy the private key to the cloud - <em>only if doing these steps on your local system</em>:<a hidden class="anchor" aria-hidden="true" href="#3-copy-the-private-key-to-the-cloud---_only-if-doing-these-steps-on-your-local-system_">#</a></h4>
<ul>
<li><code>scp -i &lt;aws-ec2-private-key&gt;.pem &lt;new_privkey&gt; ec2-user@&lt;ec2-dns-address&gt;:/home/&lt;ubuntu&gt;/.ssh/</code></li>
</ul>
<h4 id="4-on-the-system-you-are-running-these-steps-inside-sshauthorized_hosts-append-the-public-key">4. On the system you are running these steps, inside <code>.ssh/authorized_hosts</code> append the public key:<a hidden class="anchor" aria-hidden="true" href="#4-on-the-system-you-are-running-these-steps-inside-sshauthorized_hosts-append-the-public-key">#</a></h4>
<p><strong>from local machine</strong>:</p>
<ul>
<li><code>cat &lt;new_pubkey&gt;.pub | ssh -i &lt;aws-ec2-private_key&gt; | &quot;cat &gt;&gt; /home/ubuntu/.ssh/authorized_keys&quot;</code></li>
</ul>
<p><strong>inside ec2</strong>:</p>
<ul>
<li><code>cat &lt;new_pubkey&gt;.pub &gt;&gt; .ssh/authorized_keys</code></li>
</ul>
<h4 id="5-this-will-convert-our-rsa-key-into-a-dropbear-compatible-key">5. This will convert our rsa key into a dropbear compatible key<a hidden class="anchor" aria-hidden="true" href="#5-this-will-convert-our-rsa-key-into-a-dropbear-compatible-key">#</a></h4>
<ul>
<li>Login to busybox</li>
<li><code>dropbearconvert openssh dropbear &lt;new_privkey&gt; &lt;new_privkey_dropbear_compat&gt;</code></li>
</ul>
<h4 id="6-login-in-to-aws">6. Login in to AWS<a hidden class="anchor" aria-hidden="true" href="#6-login-in-to-aws">#</a></h4>
<ul>
<li><code>ssh -i &lt;new_privkey_dropbear_compat&gt; &lt;ec2-user&gt;@&lt;ec2-dns-address&gt;</code></li>
<li>profit</li>
</ul>
<h2 id="get-to-work">Get to work<a hidden class="anchor" aria-hidden="true" href="#get-to-work">#</a></h2>
<p>We can now access our AWS server from our <code>busybox</code> device. From here we can do whatever we need to do such as establish a reverse tunnel for administration ð</p>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://danielms.site/tags/ssh">ssh</a></li>
    </ul>
  </footer>
</article>
    </main><footer class="footer">
    <span>&copy; 2020 <a href="https://danielms.site/">Daniel Michaels | Software Developer</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top" accesskey="g">
    <button class="top-link" id="top-link" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6">
            <path d="M12 6H0l6-6z" /></svg>
    </button>
</a>



<script defer src="https://danielms.site/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js" integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                behavior: "smooth"
            });
        });
    });
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

</body>

</html>
