<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name=" robots" content="noindex, nofollow">
<title>Wagtail embeded YouTube videos | Daniel Michaels | Software Developer</title>

<meta name="keywords" content="python" />
<meta name="description" content="Wagtail Embed Video Wagtail is a brilliant content management service built atop of Django. It comes with all of Django&rsquo;s functionality and Django Rest Framework built in for headless work making life a lot easier.
In all, I really love it, especially its StreamFields. But I did stumble on one component, getting embedded videos to work correctly.
Embedding videos This is harder than I feel it should be and poorly explained by the Wagtail documentation.">
<meta name="author" content="Daniel Michaels">
<link rel="canonical" href="https://danielms.site/blog/wagtail-embedurl-youtube-tags/" />
<link href="https://danielms.site/assets/css/stylesheet.min.08d6f2005b6ce4ed10207916c0411c66e66f2201e3f7a56e8fb2ccbc4a8b259c.css" integrity="sha256-CNbyAFts5O0QIHkWwEEcZuZvIgHj96Vuj7LMvEqLJZw=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://danielms.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://danielms.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://danielms.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://danielms.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://danielms.site/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.78.1" />




</head>

<body class="single" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        .theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://danielms.site/" accesskey="h">Daniel Michaels | Software Developer</a>
            <span class="logo-switches">
                <span class="theme-toggle">
                    <a id="theme-toggle" accesskey="t">
                        <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </a>
                </span>
                
            </span>
        </div>
        <ul class="menu" id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://danielms.site/blog/">
                    <span>
                        Blog
                    </span>
                </a>
            </li>
            <li>
                <a href="https://danielms.site/about/">
                    <span>
                        About
                    </span>
                </a>
            </li>
            <li>
                <a href="https://github.com/danielmichaels">
                    <span>
                        Code
                    </span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">
      Wagtail embeded YouTube videos
    </h1>
    <div class="post-meta">

January 25, 2020&nbsp;Â·&nbsp;Daniel Michaels

    </div>
  </header> 

  <div class="post-content">
<h2 id="wagtail-embed-video">Wagtail Embed Video<a hidden class="anchor" aria-hidden="true" href="#wagtail-embed-video">#</a></h2>
<p><img src="https://danielms.site/images/wagtail-logo.png" alt="" title="wagtail icon"></p>
<p>Wagtail is a brilliant content management service built atop of Django. It comes with all of Django&rsquo;s functionality and Django Rest Framework built in for headless work making life a lot easier.</p>
<p>In all, I really love it, especially its <a href="https://docs.djangoproject.com/en/dev/howto/custom-template-tags/">StreamFields</a>. But I did stumble on one component, getting embedded videos to work correctly.</p>
<h3 id="embedding-videos">Embedding videos<a hidden class="anchor" aria-hidden="true" href="#embedding-videos">#</a></h3>
<p>This is harder than I feel it should be and poorly explained by the Wagtail documentation. Perhaps too harsh, in a sense - the documentation is actually really good. Except for in the circumstance whereby you want to render an embedded video inside your own HTML and CSS.</p>
<p>Before, covering that, again I should mention that wagtail&rsquo;s documentation is excellent and so too is their implementation of this Framework. For instance, you <em>can</em> render an embed video &lsquo;block&rsquo; by calling a template tag and creating the component in the model.</p>
<p>Except, it will <strong>always</strong> render this block inside a custom CSS div which apparently cannot be overridden. I&rsquo;d wager 8 out of 10 times this might mess with your sites style.</p>
<h3 id="custom-embedding-of-video-content">Custom embedding of video content<a hidden class="anchor" aria-hidden="true" href="#custom-embedding-of-video-content">#</a></h3>
<p>There is a solution to this issue; just call the <em>video.url</em> within your own implementation of an iframe element. Except, if its YouTube, and your are using a URL such as <a href="https://www.youtube.com/watch?v=xUWd3o6z2bk,">https://www.youtube.com/watch?v=xUWd3o6z2bk,</a> it will likely not run. Why? It&rsquo;s the <em>watch</em> url endpoint. YouTube, wants embedded videos to use <a href="https://www.youtube.com/embed?v=xUWd3o6z2bk">https://www.youtube.com/embed?v=xUWd3o6z2bk</a> instead. <strong>Note</strong> the use of <em>embed</em> in place of <em>watch</em>.</p>
<p>And, wagtail will not accept YouTube urls containing <em>embed</em> causing a template error. So what&rsquo;s a person to do; custom template tags to override this blocker!</p>
<h3 id="code-or-gtfo">Code or GTFO<a hidden class="anchor" aria-hidden="true" href="#code-or-gtfo">#</a></h3>
<p>Lets create a VideoBlock that will embed a video component into our template.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># blocks.py</span>
<span class="k">class</span> <span class="nc">VideoBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">.</span><span class="n">StructBlock</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Only used for Video Card modals.&#34;&#34;&#34;</span>
    <span class="n">video</span> <span class="o">=</span> <span class="n">EmbedBlock</span><span class="p">()</span> <span class="c1"># &lt;-- the part we need</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s2">&#34;streams/video_card_block.html&#34;</span>
        <span class="n">icon</span> <span class="o">=</span> <span class="s2">&#34;media&#34;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&#34;Embed Video&#34;</span>
</code></pre></div><p>This will now give us a StreamField which we can then use to enter the url we wish to embed into the template. In this example the url we are entering into our StreamField video_card_block is <a href="https://www.youtube.com/watch?v=xUWd3o6z2bk">https://www.youtube.com/watch?v=xUWd3o6z2bk</a></p>
<p>Next, in the video block template we&rsquo;ll use Bootstrap&rsquo;s embedded video component and inject the url into the <em>src</em> attribute.</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="c">&lt;!--  video_card_block.html --&gt;</span>
{% load wagtailcore_tags wagtailembeds_tags %}

{% block content %}
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;embed-responsive embed-responsive-16by9&#34;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;embed-responsive-item&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;{{ self.video.url }}?rel=0&#34;</span> <span class="na">allowfullscreen</span><span class="p">&gt;&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
{% endblock %}
</code></pre></div><p>Unfortunately, this will render it as seen below, and be blocked by YouTube. In fact when it is blocked, you will need to consult dev tools to see that wagtail did indeed render the HTML.</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;embed-responsive embed-responsive-16by9&#34;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;embed-responsive-item&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;https://www.youtube.com/watch/zpOULjyy-n8?rel=0&#34;</span> <span class="na">allowfullscreen</span><span class="p">&gt;&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div><p>To fix this we need to create a <a href="https://docs.djangoproject.com/en/dev/howto/custom-template-tags/">custom template tag</a> which will intercept the <em>watch</em> url and inject the <em>embed</em> url into the template. This will make wagtail&rsquo;s embed <a href="https://github.com/wagtail/wagtail/blob/master/wagtail/embeds/oembed_providers.py">classifiers</a> happy and us too.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>

<span class="nd">@register.filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;embedurl&#34;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_embed_url_with_parameters</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&#34;youtube.com&#34;</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">or</span> <span class="s2">&#34;youtu.be&#34;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;(?:https:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?(.+)&#34;</span>  <span class="c1"># Get video id from URL</span>
        <span class="n">embed_url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="n">regex</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&#34;https://www.youtube.com/embed/\1&#34;</span><span class="p">,</span> <span class="n">url</span>
        <span class="p">)</span>  <span class="c1"># Append video id to desired URL</span>
        <span class="k">print</span><span class="p">(</span><span class="n">embed_url</span><span class="p">)</span>
        <span class="n">embed_url_with_parameters</span> <span class="o">=</span> <span class="n">embed_url</span> <span class="o">+</span> <span class="s2">&#34;?rel=0&#34;</span>  <span class="c1"># Add additional parameters</span>
        <span class="k">return</span> <span class="n">embed_url_with_parameters</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</code></pre></div><p>This will now render the <em>embed</em> url as expected and upon inspection with dev tools should look like so:</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;embed-responsive embed-responsive-16by9&#34;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;embed-responsive-item&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;https://www.youtube.com/embed/zpOULjyy-n8?rel=0&#34;</span> <span class="na">allowfullscreen</span><span class="p">&gt;&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div><h3 id="fixed">fixed<a hidden class="anchor" aria-hidden="true" href="#fixed">#</a></h3>
<p>I Searched the internet for hours and only after piecing it together over time did I eventually unlock this riddle! This is still an <a href="https://github.com/wagtail/wagtail/issues/4127">open</a> ticket on the tail issue tracker!</p>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://danielms.site/tags/python">python</a></li>
    </ul>
  </footer>
</article>
    </main><footer class="footer">
    <span>&copy; 2020 <a href="https://danielms.site/">Daniel Michaels | Software Developer</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top" accesskey="g">
    <button class="top-link" id="top-link" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6">
            <path d="M12 6H0l6-6z" /></svg>
    </button>
</a>



<script defer src="https://danielms.site/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js" integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                behavior: "smooth"
            });
        });
    });
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

</body>

</html>
